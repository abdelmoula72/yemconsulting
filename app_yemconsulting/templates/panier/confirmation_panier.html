{% extends "base.html" %}
{% load static widget_tweaks %}

{% block extra_js %}
  <script src="{% static 'js/panier_confirmation.js' %}" defer></script>
{% endblock %}

{% block title %}Vérifiez votre commande{% endblock %}

{% block content %}
<div class="container my-4">
  <form method="post" id="confirm-form" class="row g-4">
    {% csrf_token %}
    <div class="col-lg-8">
      <h5 class="mb-3"><i class="bi bi-box-seam"></i> Commande</h5>
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Article</th><th class="text-center">Qté</th><th class="text-end">Prix&nbsp;TTC</th>
          </tr>
        </thead>
        <tbody>
          {% for ligne in lignes %}
            <tr>
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if ligne.image_url %}
                    <img src="{{ ligne.image_url }}" class="prod-mini" width="64">
                  {% else %}
                    <img src="{% static 'default.jpg' %}" class="prod-mini" width="64">
                  {% endif %}
                  <span>{{ ligne.nom }}</span>
                </div>
              </td>
              <td class="text-center">{{ ligne.quantite }}</td>
              <td class="text-end">{{ ligne.prix }} €</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-lg-4">
      <h5 class="mb-3"><i class="bi bi-truck"></i> Délai de livraison prévu</h5>

      {% for code, opt in livraisons.items %}
        <div class="form-check mb-2">
          <input class="form-check-input liv-option"
                 type="radio" name="livraison"
                 id="liv-{{ code }}" value="{{ code }}"
                 data-price="{{ opt.prix }}"
                 {% if code == livraison_select %}checked{% endif %}>
          <label class="form-check-label w-100" for="liv-{{ code }}">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="flex-grow-1">
                <span class="d-block">{{ opt.libelle }}</span>
                <small class="text-muted">{{ opt.delai }}</small>
              </div>
              <strong class="ps-4">
                {% if opt.prix == 0 %}Gratuite{% else %}{{ opt.prix|floatformat:2 }} €{% endif %}
              </strong>
            </div>
          </label>
        </div>
      {% endfor %}

      <hr>

      <p class="d-flex justify-content-between">
        <span>Sous-total :</span>
        <strong id="sousttc" data-val="{{ sous_total|floatformat:2 }}">
          {{ sous_total }} €
        </strong>
      </p>
      <p class="d-flex justify-content-between">
        <span>Livraison :</span>
        <strong id="livPrx">{% if livraison.prix == 0 %}Gratuite{% else %}{{ livraison.prix|floatformat:2 }} €{% endif %}</strong>
      </p>
      <p class="d-flex justify-content-between fs-5">
        <span>Total TTC :</span>
        <strong id="totttc">{{ total_ttc }} €</strong>
      </p>

      <!-- Adresse de livraison + bouton Modifier -->
      <div class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="mb-0 fs-5">
            <i class="bi bi-geo-alt-fill me-1 text-primary"></i>
            Adresse de livraison
          </h3>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalAdresses">
            Modifier
          </button>
        </div>
        <address class="fw-bold lh-sm" id="adresseLivraison">
          {% if adresse_livraison %}
            {{ adresse_livraison.utilisateur.get_full_name }}<br>
            {{ adresse_livraison.adresse }}<br>
            {% if adresse_livraison.complement %}{{ adresse_livraison.complement }}<br>{% endif %}
            {{ adresse_livraison.code_postal }} {{ adresse_livraison.ville }}<br>
            {{ adresse_livraison.pays }}
          {% else %}
            {{ utilisateur.prenom }} {{ utilisateur.nom }}<br>
            {{ utilisateur.adresse }}<br>
            {% if utilisateur.complement_adresse %}{{ utilisateur.complement_adresse }}<br>{% endif %}
            {{ utilisateur.code_postal }} {{ utilisateur.ville }}<br>
            {{ utilisateur.pays }}
          {% endif %}
        </address>
      </div>

      <button class="btn btn-primary w-100 mt-3" type="submit">
        Valider votre commande
      </button>
    </div>
  </form>
</div>

<!-- Modal pour la sélection d'adresse -->
<div class="modal fade" id="modalAdresses" tabindex="-1" aria-labelledby="modalAdressesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAdressesLabel">Sélectionner une adresse de livraison</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="list-group">
          {% for adresse in adresses %}
            <label class="list-group-item d-flex gap-2">
              <input class="form-check-input flex-shrink-0" type="radio" name="adresseLivraison" 
                     value="{{ adresse.id }}" 
                     {% if adresse.id == adresse_livraison.id %}checked{% endif %}>
              <div>
                <strong>{{ adresse.utilisateur.get_full_name }}</strong><br>
                {{ adresse.adresse }}<br>
                {% if adresse.complement %}{{ adresse.complement }}<br>{% endif %}
                {{ adresse.code_postal }} {{ adresse.ville }}<br>
                {{ adresse.pays }}
              </div>
            </label>
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="validerAdresse">Valider</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la sélection d'adresse
    const modalAdresses = document.getElementById('modalAdresses');
    const validerAdresse = document.getElementById('validerAdresse');
    const adresseLivraison = document.getElementById('adresseLivraison');
    
    validerAdresse.addEventListener('click', function() {
        const selectedAdresse = document.querySelector('input[name="adresseLivraison"]:checked');
        if (selectedAdresse) {
            const adresseId = selectedAdresse.value;
            // Envoyer une requête AJAX pour mettre à jour l'adresse de livraison
            fetch(`/update-shipping-address/${adresseId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la mise à jour de l\'adresse');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mettre à jour l'affichage de l'adresse
                    adresseLivraison.innerHTML = `
                        ${data.nom}<br>
                        ${data.adresse}<br>
                        ${data.complement ? data.complement + '<br>' : ''}
                        ${data.code_postal} ${data.ville}<br>
                        ${data.pays}
                    `;
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(modalAdresses);
                    if (modal) {
                        modal.hide();
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la mise à jour de l\'adresse');
            });
        }
    });
});
</script>
{% endblock %}
